From cccda33662a8e9ce0e9ce2fc05dd02759f1173d3 Mon Sep 17 00:00:00 2001
From: Sean V Kelley <sean.v.kelley@linux.intel.com>
Date: Mon, 3 Dec 2018 09:25:08 -0800
Subject: [PATCH] Install locale files to different location

2019-08-23: Rebased for update to 2.80
2021-02-21: Revised patch subject; rebased for update to 2.91.2

Signed-off-by: Li, Guangli <guangli.li@intel.com>
Signed-off-by: Patrick McCarty <patrick.mccarty@intel.com>
---
 source/blender/blenkernel/BKE_appdir.hh           | 1 +
 source/blender/blenkernel/intern/appdir.cc        | 2 ++
 source/blender/blentranslation/intern/blt_lang.cc | 4 ++--
 source/creator/CMakeLists.txt                     | 2 +-
 4 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/source/blender/blenkernel/BKE_appdir.hh b/source/blender/blenkernel/BKE_appdir.hh
index d82bb33..d2b4b06 100644
--- a/source/blender/blenkernel/BKE_appdir.hh
+++ b/source/blender/blenkernel/BKE_appdir.hh
@@ -168,6 +168,7 @@ enum {
   BLENDER_SYSTEM_SCRIPTS = 53,
   BLENDER_SYSTEM_EXTENSIONS = 54,
   BLENDER_SYSTEM_PYTHON = 55,
+  BLENDER_SYSTEM_LOCALE = 56,
 };
 
 /** For #BKE_appdir_folder_id_version only. */
diff --git a/source/blender/blenkernel/intern/appdir.cc b/source/blender/blenkernel/intern/appdir.cc
index 01e6fee..95c50c5 100644
--- a/source/blender/blenkernel/intern/appdir.cc
+++ b/source/blender/blenkernel/intern/appdir.cc
@@ -700,6 +700,8 @@ bool BKE_appdir_folder_id_ex(const int folder_id,
         break;
       }
       return false;
+    case BLENDER_SYSTEM_LOCALE:
+      BLI_strncpy(path, "/usr/share/locale", FILE_MAX); break;
 
     default:
       BLI_assert_unreachable();
diff --git a/source/blender/blentranslation/intern/blt_lang.cc b/source/blender/blentranslation/intern/blt_lang.cc
index b6c8074..82915e8 100644
--- a/source/blender/blentranslation/intern/blt_lang.cc
+++ b/source/blender/blentranslation/intern/blt_lang.cc
@@ -67,7 +67,7 @@ static void free_locales()
 
 static void fill_locales()
 {
-  std::optional<std::string> languages_path = BKE_appdir_folder_id(BLENDER_DATAFILES, "locale");
+  std::optional<std::string> languages_path = BKE_appdir_folder_id(BLENDER_SYSTEM_LOCALE, nullptr);
   if (!languages_path.has_value()) {
     CLOG_WARN(&LOG, "'locale' data path for translations not found");
     return;
@@ -248,7 +248,7 @@ void BLT_lang_set(const char *str)
   std::string locale_name = str ? str : LOCALE(ulang);
 
   /* blender::locale assumes UTF-8, no need to put it in the name. */
-  const std::optional<std::string> messagepath = BKE_appdir_folder_id(BLENDER_DATAFILES, "locale");
+  const std::optional<std::string> messagepath = BKE_appdir_folder_id(BLENDER_SYSTEM_LOCALE, nullptr);
   blender::locale::init(locale_name, {TEXT_DOMAIN_NAME}, {messagepath.value_or("")});
 
 #else
diff --git a/source/creator/CMakeLists.txt b/source/creator/CMakeLists.txt
index cc7dff1..17940f1 100644
--- a/source/creator/CMakeLists.txt
+++ b/source/creator/CMakeLists.txt
@@ -511,7 +511,7 @@ install(
 # localization
 if(WITH_INTERNATIONAL)
   set(_locale_dir "${CMAKE_SOURCE_DIR}/locale")
-  set(_locale_target_dir ${TARGETDIR_VER}/datafiles/locale)
+  set(_locale_target_dir ${CMAKE_INSTALL_PREFIX}/share/locale)
 
   file(GLOB _po_files "${_locale_dir}/po/*.po")
   foreach(_po_file ${_po_files})
-- 
2.49.0

